name: Sync GitHub Daily Stats

# repository_dispatch: å¤–éƒ¨ã‹ã‚‰å‘¼ã³å‡ºã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ
# workflow_dispatch: GitHub UI ã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œå¯èƒ½
# schedule: æ¯æ—¥24:00ï¼ˆJSTï¼‰= 15:00ï¼ˆUTCï¼‰ã«è‡ªå‹•å®Ÿè¡Œ
on:
  schedule:
    # æ¯æ—¥15:00 UTC = 24:00 JSTï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰
    - cron: '0 15 * * *'
  repository_dispatch:
    types: [sync-daily-stats]
  workflow_dispatch:

jobs:
  sync-stats:
    runs-on: ubuntu-latest

    steps:
      - name: Call Vercel Sync API
        run: |
          echo "ğŸš€ Starting GitHub stats synchronization..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://uni-pathfinder-lf9w.vercel.app/api/github/sync-daily-stats \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "ğŸ“Š HTTP Status: $http_code"
          echo "ğŸ“¦ Response Body:"
          echo "$body" | jq '.' || echo "$body"

          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Sync completed successfully!"

            # ã‚µãƒãƒªãƒ¼ã‚’æŠ½å‡ºã—ã¦è¡¨ç¤º
            total_users=$(echo "$body" | jq -r '.summary.totalUsers // "N/A"')
            success_count=$(echo "$body" | jq -r '.summary.successCount // "N/A"')
            failure_count=$(echo "$body" | jq -r '.summary.failureCount // "N/A"')
            total_days=$(echo "$body" | jq -r '.summary.totalDaysSynced // "N/A"')

            echo "ğŸ“ˆ Summary:"
            echo "  - Total Users: $total_users"
            echo "  - Success: $success_count"
            echo "  - Failure: $failure_count"
            echo "  - Total Days Synced: $total_days"
          else
            echo "âŒ Sync failed with status code: $http_code"
            exit 1
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "âš ï¸ GitHub stats sync failed. Please check the logs."
