# GitHub REST API実装要件：認証と考慮事項

このドキュメントは、GitHub REST APIを利用してユーザーアクティビティの可視化およびリポジトリコード分析を行うシステムを構築する際に、AIが実装を進める上で必要となる認証情報と、その他の重要な実装要件をまとめます。

## 1. 目的

AIがGitHub REST APIを安全かつ効率的に利用し、ユーザーのGitHubデータを取得・分析するために必要な前提条件と技術的考慮事項を明確にすることを目的とします。

## 2. 認証情報

GitHub REST APIへのアクセスには、適切な認証情報が必要です。ユーザーのプライベートデータにアクセスするためには、認証されたアクセスが必須となります。

### 2.1. Personal Access Token (PAT)

開発初期段階や個人利用の場合に簡便な認証方法です。ユーザーは自身のGitHubアカウントでPATを生成し、システムに提供する必要があります。

*   **生成方法**: GitHubの「Settings」->「Developer settings」->「Personal access tokens」->「Tokens (classic)」または「Fine-grained tokens」から生成します。
*   **必要なスコープ/パーミッション**:
    *   **アクティビティ可視化のため**:
        *   `user`スコープ（ユーザーのプライベートイベントへのアクセス）
        *   `repo`スコープ（プライベートリポジトリのイベントへのアクセス）
        *   または、Fine-grained tokensの場合、「Events」ユーザーパーミッション (read) と「Metadata」リポジトリパーミッション (read) を設定します。
    *   **リポジトリコード分析のため**:
        *   `repo`スコープ（プライベートリポジトリのコンテンツへのアクセス）
        *   または、Fine-grained tokensの場合、「Contents」リポジトリパーミッション (read)、「Metadata」リポジトリパーミッション (read)、「Dependency graph」リポジトリパーミッション (read) を設定します。
*   **注意点**: PATはユーザーのパスワードと同様に扱われるべきであり、厳重に管理する必要があります。環境変数として設定するか、セキュアな方法で保存・利用することが推奨されます。

### 2.2. GitHub App

本番環境や、よりセキュアで詳細なアクセス制御が必要なサービスには、GitHub Appの利用が推奨されます。GitHub Appは、特定のパーミッションとリポジトリへのアクセスを細かく制御できます。

*   **登録方法**: GitHubの「Settings」->「Developer settings」->「GitHub Apps」から新しいGitHub Appを登録します。
*   **必要なパーミッション**:
    *   **リポジトリパーミッション**:
        *   `contents:read` (リポジトリのコンテンツへのアクセス)
        *   `issues:read` (Issue関連イベントへのアクセス)
        *   `pull_requests:read` (Pull Request関連イベントへのアクセス)
        *   `metadata:read` (リポジトリのメタデータ、言語統計などへのアクセス)
        *   `dependency_graph:read` (依存関係グラフへのアクセス)
    *   **ユーザーパーミッション**:
        *   `events:read` (ユーザーのイベントへのアクセス)
*   **認証フロー**: GitHub Appは、OAuthフローを通じてユーザーにインストールを促し、インストールアクセストークンやユーザーアクセストークンを発行します。これらのトークンを使用してAPIリクエストを行います。
*   **注意点**: GitHub Appの登録には、Webhook URLやコールバックURLの設定が必要です。また、秘密鍵の管理も重要になります。

## 3. 実装上の考慮事項

### 3.1. APIレート制限

GitHub APIには厳格なレート制限があります。これを遵守しないと、APIアクセスが一時的にブロックされる可能性があります。

*   **監視**: レスポンスヘッダー (`X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`) を常に監視し、残りのリクエスト数とリセット時間を把握します。
*   **待機**: レート制限に達した場合は、`X-RateLimit-Reset`で示される時間まで待機してからリクエストを再試行するロジックを実装します。
*   **キャッシュ**: 頻繁にアクセスするデータはキャッシュし、APIコールの回数を減らします。

### 3.2. エラーハンドリング

APIリクエストは様々な理由で失敗する可能性があります。堅牢なシステムには適切なエラーハンドリングが不可欠です。

*   **HTTPステータスコード**: `401 Unauthorized` (認証エラー)、`403 Forbidden` (レート制限超過または権限不足)、`404 Not Found` (リソースが見つからない) など、主要なHTTPステータスコードに対応する処理を実装します。
*   **リトライ戦略**: 一時的なネットワーク問題やサービス側の問題に備え、指数バックオフなどのリトライ戦略を実装します。

### 3.3. データ永続化と更新戦略

取得したデータは、ダッシュボードでの利用や履歴分析のために永続化する必要があります。

*   **データベース**: 取得したイベントデータやリポジトリ分析結果をリレーショナルデータベース（PostgreSQL, MySQLなど）またはNoSQLデータベース（MongoDBなど）に保存します。
*   **増分更新**: GitHubのイベントAPIは過去30日または300件のイベントに制限があるため、定期的に（例: 毎日）最新のイベントを取得し、データベースに増分更新する仕組みが必要です。
*   **データモデル**: 取得するイベントの種類やリポジトリの構造に合わせて、適切なデータモデルを設計します。

### 3.4. タイムゾーンの考慮

GitHub APIから返されるタイムスタンプは通常UTCです。ダッシュボードで表示する際には、ユーザーのローカルタイムゾーンに変換する必要があります。

### 3.5. 大規模リポジトリとコード分析

大規模なリポジトリのコード分析は、APIコール数や処理時間に大きな影響を与える可能性があります。

*   **コンテンツ取得の最適化**: すべてのファイルコンテンツを一度に取得するのではなく、必要なファイルのみを対象とする、または部分的に取得するなどの最適化を検討します。
*   **外部ツールの統合**: コードの複雑性指標など、GitHub APIが直接提供しないデータについては、外部の静的コード解析ツール（例: SonarQube, CodeClimate）を統合するか、リポジトリをローカルにクローンして解析する仕組みを検討します。後者の場合、サンドボックス環境での実行や、ユーザーの同意とリポジトリのクローン権限が必要になります。

### 3.6. フォークされたリポジトリの貢献度分析

ユーザーがフォークしたリポジトリでの貢献度を正確に測定するには、以下の追加ロジックが必要です。

*   **コミットのフィルタリング**: フォークされたリポジトリのコミット履歴から、対象ユーザーが`author`または`committer`であるコミットを特定します。
*   **差分分析**: これらのコミットがフォーク元のリポジトリにマージされたPull Requestに関連しているか、またはユーザーが独自に追加・変更したコードであるかを、コミットの差分情報 (`files`フィールド) を分析することで判断します。

## 4. まとめ

GitHub REST APIを利用したシステム構築には、適切な認証情報の準備と、APIの特性（レート制限、非リアルタイム性など）を理解した上での設計が不可欠です。特に、ユーザーのプライベートデータへのアクセスには、PATまたはGitHub Appの適切なスコープ/パーミッション設定が求められます。これらの要件を考慮し、堅牢でスケーラブルなシステムを構築することが重要です。

