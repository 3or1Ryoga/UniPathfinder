# GitHub REST API仕様書：リポジトリコード分析

このドキュメントは、GitHub REST APIを使用してユーザーのリポジトリのコードに関するデータを取得し、そのプロジェクトのレベル感や特性を評価するためのAPI仕様を定義します。

## 1. 目的

ユーザーのリポジトリのコードベースを分析し、コード行数、使用言語、ファイルの種類、依存関係、コードの複雑性などの指標を通じて、その開発スキルやプロジェクトの特性を把握するためのAPI要件を明確にします。

## 2. 取得対象データ

以下のコード関連データを対象とします。

*   **コード行数 (Lines of Code)**
*   **ファイルの種類 (File Types)**
*   **使用言語 (Used Languages)**
*   **依存関係 (Dependencies)**
*   **コードの複雑性指標 (Code Complexity Metrics)**

## 3. APIエンドポイントとデータ取得方法

### 3.1. リポジトリの言語統計の取得

リポジトリで使用されているプログラミング言語とそのバイト数を取得します。これにより、主要な使用言語と、各言語でのコード量を把握できます。

*   **エンドポイント**: `GET /repos/{owner}/{repo}/languages`

**パスパラメータ**: 

*   `owner`: リポジトリの所有者。
*   `repo`: リポジトリ名。

**レスポンス**: 各言語名とその言語で書かれたコードのバイト数をキーと値とするJSONオブジェクト。

### 3.2. リポジトリコンテンツの取得（コード行数、ファイルの種類）

リポジトリのツリー構造とファイルコンテンツを取得することで、コード行数とファイルの種類を特定します。GitHub APIは直接コード行数を返さないため、ファイルコンテンツを取得後に解析が必要です。

*   **エンドポイント**: `GET /repos/{owner}/{repo}/git/trees/{tree_sha}?recursive=1`
    *   `tree_sha`はリポジトリのデフォルトブランチの最新のツリーSHAです。これは`GET /repos/{owner}/{repo}/branches/{branch}`で取得できます。

**パスパラメータ**: 

*   `owner`: リポジトリの所有者。
*   `repo`: リポジトリ名。
*   `tree_sha`: ツリーのSHA。

**クエリパラメータ**: 

*   `recursive`: `1`を設定すると、サブディレクトリを含むツリー全体を再帰的に取得します。

**レスポンス**: ツリーオブジェクトの配列。各オブジェクトはファイルまたはディレクトリを表し、`path`、`mode`、`type`、`size`、`sha`などの情報を含みます。

ファイルコンテンツの取得:

*   **エンドポイント**: `GET /repos/{owner}/{repo}/contents/{path}`

**パスパラメータ**: 

*   `owner`: リポジトリの所有者。
*   `repo`: リポジトリ名。
*   `path`: ファイルへのパス。

**レスポンス**: ファイルコンテンツオブジェクト。`content`フィールドにはBase64エンコードされたファイル内容が含まれます。これをデコードしてコード行数をカウントし、ファイル拡張子からファイルの種類を特定します。

### 3.3. 依存関係の取得

GitHub APIには直接的な依存関係グラフのエンドポイントがありますが、これは主にセキュリティ目的（Dependabot alertsなど）で利用されます。プロジェクトの依存関係を詳細に把握するには、リポジトリのコンテンツ（例: `package.json`, `requirements.txt`, `pom.xml`など）を解析する必要があります。

*   **エンドポイント**: `GET /repos/{owner}/{repo}/dependency-graph/sbom` (Software Bill of Materials)
    *   このエンドポイントは、リポジトリの依存関係に関するSBOMを返します。これは、依存関係の概要を把握するのに役立ちます。

**パスパラメータ**: 

*   `owner`: リポジトリの所有者。
*   `repo`: リポジトリ名。

**レスポンス**: SBOM形式の依存関係情報。

より詳細な依存関係解析には、以下の手順を検討します。

1.  リポジトリコンテンツから依存関係定義ファイル（例: `package.json`, `requirements.txt`, `Gemfile`, `pom.xml`など）を特定し、その内容を取得します。
2.  取得したファイルの内容を解析し、プロジェクトの依存関係を抽出します。

### 3.4. コードの複雑性指標の取得

GitHub REST APIは直接コードの複雑性指標（例: 循環的複雑度、凝集度、結合度）を提供しません。これらの指標を計算するには、以下のいずれかのアプローチが必要です。

1.  **外部ツール/サービスとの連携**: SonarQube, CodeClimateなどのコード品質分析ツールをGitHubリポジトリと連携させ、それらのAPIを通じて複雑性指標を取得します。
2.  **ローカルでのコード解析**: リポジトリをクローンし、静的コード解析ツール（例: PythonのRadon, JavaScriptのESLint, JavaのPMDなど）を使用して複雑性指標を計算します。このアプローチは、サンドボックス環境での実行や、ユーザーの同意とリポジトリのクローン権限が必要です。

## 4. フォークされたリポジトリでのユーザー貢献度

ユーザーがフォークしたリポジトリの場合、そのユーザーが追加したコードに関するデータを取得するには、以下の手順を検討します。

1.  フォークされたリポジトリのコミット履歴を取得します。
2.  各コミットの`author`または`committer`が対象ユーザーであるかを確認します。
3.  対象ユーザーによるコミットに含まれる変更（`files`フィールドの`additions`と`deletions`）を分析し、コード行数やファイルの種類、使用言語への貢献度を算出します。
4.  フォーク元のリポジトリとの差分を比較し、ユーザーが独自に追加・変更したコードを特定することで、より正確な貢献度を評価できます。

## 5. 認証

リポジトリのコンテンツや依存関係、プライベートリポジトリの情報にアクセスするためには、適切な認証が必要です。Personal Access Token (PAT) またはGitHub Appを利用します。

*   **Personal Access Token (PAT)**: `repo`スコープを持つPATを使用します。
*   **GitHub App**: `contents:read`、`metadata:read`、`dependency_graph:read`などのリポジトリパーミッションを設定します。

## 6. レート制限とエラーハンドリング

「GitHub REST API仕様書：ユーザーアクティビティ可視化」ドキュメントと同様に、GitHub APIのレート制限と適切なエラーハンドリングを考慮する必要があります。

## 7. 実装に関する考慮事項

*   **大規模リポジトリの処理**: 大規模なリポジトリの場合、すべてのファイルコンテンツを取得・解析するのは時間がかかり、APIレート制限に抵触する可能性があります。必要に応じて、サンプリングやキャッシュ戦略を検討します。
*   **コード解析ツールの統合**: コードの複雑性指標を計算するために、外部の静的コード解析ツールをシステムに統合する方法を検討します。
*   **データ永続化**: 取得・解析したコードデータはデータベースなどに保存し、履歴データとして利用できるようにします。

