# GitHub REST API仕様書：ユーザーアクティビティ可視化

このドキュメントは、GitHub REST APIを使用してユーザーのGitHubアクティビティ（コミット、プッシュ、Issue、Pull Request、スター、フォークなど）を時系列で取得し、ダッシュボードで可視化するためのAPI仕様を定義します。

## 1. 目的

ユーザーのGitHub上での活動を総合的に把握し、その貢献度や活動傾向を週次で可視化するダッシュボードを構築するためのAPI要件を明確にします。

## 2. 取得対象アクティビティ

以下のGitHubアクティビティを対象とします。

*   **コミット (Commits)**: ユーザーが行ったコミット。
*   **プッシュ (Pushes)**: ユーザーが行ったリポジトリへのプッシュ。
*   **Issue関連 (Issues)**: Issueの作成、コメント、クローズなど。
*   **Pull Request関連 (Pull Requests)**: Pull Requestの作成、レビュー、マージなど。
*   **スター (Stars)**: ユーザーがリポジトリにスターを付けた/外したイベント。
*   **フォーク (Forks)**: ユーザーがリポジトリをフォークしたイベント。

## 3. APIエンドポイントとデータ取得方法

GitHub REST APIの`Events`エンドポイントを中心に利用します。ユーザーの公開イベントと、認証されたユーザーのプライベートイベントを取得します。

### 3.1. ユーザーイベントの取得

認証されたユーザーのイベント、または公開ユーザーイベントを取得します。これにより、コミット、プッシュ、Issue、Pull Request、スター、フォークなどの様々なイベントタイプを捕捉できます。

*   **エンドポイント**: `GET /users/{username}/events` (認証されたユーザーのイベント)
    *   プライベートイベントを含めるには、`user`スコープを持つPersonal Access Token (PAT) またはGitHub Appのユーザーアクセス・トークンが必要です。
*   **エンドポイント**: `GET /users/{username}/events/public` (公開ユーザーイベント)

**クエリパラメータ**: 

*   `per_page`: ページあたりの結果数 (最大100)。
*   `page`: 取得するページ番号。

**レスポンス**: イベントオブジェクトの配列。各イベントオブジェクトには`type`フィールドがあり、イベントの種類を示します（例: `PushEvent`, `IssuesEvent`, `PullRequestEvent`, `WatchEvent` (スター), `ForkEvent`）。

**注意点**: 

*   GitHubのイベントAPIはリアルタイム用途には適していません。イベントの遅延が発生する可能性があります。
*   イベントは過去300件、または過去30日間のものに制限されます。

### 3.2. コミット詳細の取得

`PushEvent`からリポジトリ名とコミットSHAを取得し、個々のコミットの詳細情報を取得します。

*   **エンドポイント**: `GET /repos/{owner}/{repo}/commits/{ref}`

**パスパラメータ**: 

*   `owner`: リポジトリの所有者。
*   `repo`: リポジトリ名。
*   `ref`: コミットのSHA、ブランチ名、またはタグ名。

**レスポンス**: コミット詳細オブジェクト。`author`、`committer`、`commit`メッセージ、`files`（変更されたファイルリスト）などの情報が含まれます。

### 3.3. フォークされたリポジトリでのユーザー貢献度の追跡

ユーザーがフォークしたリポジトリにおいて、そのユーザーが実際に行ったコミットを特定するには、以下の手順を検討します。

1.  ユーザーのイベントから`ForkEvent`を検出し、フォーク元のリポジトリとフォークされたリポジトリの情報を取得します。
2.  フォークされたリポジトリのコミット履歴を`GET /repos/{owner}/{repo}/commits`で取得します。
3.  取得したコミットの中から、`committer`または`author`が対象ユーザーであるコミットをフィルタリングします。
4.  さらに、これらのコミットがフォーク元のリポジトリにマージされたPull Requestに関連しているかを確認することで、ユーザーの貢献度をより正確に把握できます。

## 4. データ集計と可視化の粒度

取得したイベントデータを週次で集計し、以下の指標を可視化します。

*   **総アクティビティ数**: 全イベントタイプの合計数。
*   **イベントタイプ別アクティビティ数**: コミット、プッシュ、Issue、Pull Request、スター、フォークごとの数。
*   **コミット数**: 週ごとのコミット数。
*   **プッシュ数**: 週ごとのプッシュ数。
*   **Issue作成/コメント数**: 週ごとのIssue関連アクティビティ数。
*   **Pull Request作成/レビュー数**: 週ごとのPull Request関連アクティビティ数。

## 5. 認証

ユーザーのプライベートリポジトリやプライベートイベントにアクセスするためには、適切な認証が必要です。Personal Access Token (PAT) またはGitHub Appを利用します。

*   **Personal Access Token (PAT)**: `user`および`repo`スコープを持つPATを使用します。
*   **GitHub App**: よりセキュアで柔軟なアクセス制御が可能です。`contents:read`、`issues:read`、`pull_requests:read`、`metadata:read`、`repository_hooks:read`などのリポジトリパーミッションと、`events:read`などのユーザーパーミッションを設定します。

## 6. レート制限

GitHub APIにはレート制限があります。制限を超えないように、適切な間隔でAPIコールを行う必要があります。レート制限情報はレスポンスヘッダーに含まれます。

*   `X-RateLimit-Limit`: 1時間あたりの最大リクエスト数。
*   `X-RateLimit-Remaining`: 残りのリクエスト数。
*   `X-RateLimit-Reset`: レート制限がリセットされるまでのUNIXタイムスタンプ。

## 7. エラーハンドリング

APIコールが失敗した場合に備え、適切なエラーハンドリングを実装します。特にレート制限超過 (`403 Forbidden`) や認証エラー (`401 Unauthorized`) には注意が必要です。

## 8. 実装に関する考慮事項

*   **データ永続化**: 取得したイベントデータはデータベースなどに保存し、履歴データとして利用できるようにします。
*   **増分更新**: 毎日または定期的にイベントデータを取得し、増分更新を行うことで、最新の情報をダッシュボードに反映させます。
*   **タイムゾーン**: イベントのタイムスタンプはUTCで提供されるため、表示時にはユーザーのタイムゾーンに変換する必要があります。

